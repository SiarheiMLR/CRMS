<UserControl x:Class="CRMS.Views.Support.TicketListControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:metro="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes" 
             xmlns:local="clr-namespace:CRMS.Views.Support"
             xmlns:viewModels="clr-namespace:CRMS.ViewModels.Support"
             xmlns:converters="clr-namespace:CRMS.Infrastructure.Converters"
             xmlns:domain="clr-namespace:CRMS.Domain.Entities;assembly=CRMS.Domain"
             mc:Ignorable="d"
             Background="Transparent"
             Height="Auto" Width="Auto">

    <UserControl.Resources>
        <converters:StatusToRussianConverter x:Key="StatusToRussianConverter"/>
        <converters:PriorityToRussianConverter x:Key="PriorityToRussianConverter"/>
        <converters:StatusToColorConverter x:Key="StatusToColorConverter"/>
        <converters:PriorityToColorConverter x:Key="PriorityToColorConverter"/>

        <!-- Базовый стиль -->
        <Style x:Key="ColumnHeaderStyle" TargetType="GridViewColumnHeader">
            <Setter Property="Background" Value="#666666"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="BorderThickness" Value="0,0,1,2"/>
            <Setter Property="BorderBrush" Value="LightGray"/>
        </Style>

        <!-- Для самой первой колонки -->
        <Style x:Key="FirstColumnHeaderStyle" TargetType="GridViewColumnHeader" BasedOn="{StaticResource ColumnHeaderStyle}">
            <Setter Property="BorderThickness" Value="2,0,1,2"/>
        </Style>

        <!-- Стиль для элементов списка -->
        <Style x:Key="TicketListItemStyle" TargetType="ListViewItem">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#444444"/>
                    <Setter Property="BorderBrush" Value="#666666"/>
                    <Setter Property="BorderThickness" Value="1"/>
                </Trigger>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#3A3A3A"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Border CornerRadius="8"
            BorderThickness="1"
            BorderBrush="{DynamicResource MaterialDesignDivider}"
            Background="Transparent"
            Margin="0,0,0,0"
            Padding="10">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <StackPanel>
                <TextBlock Text="Список заявок"
                       HorizontalAlignment="Center"
                       FontSize="16"
                       Foreground="White"
                       FontWeight="Bold"
                       Margin="0,0,0,10"/>

                <!-- Список -->
                <ListView ItemsSource="{Binding FilteredTickets}"
                      SelectedItem="{Binding SelectedTicket, Mode=TwoWay}"
                      ItemContainerStyle="{StaticResource TicketListItemStyle}"
                      ScrollViewer.HorizontalScrollBarVisibility="Auto"
                      ScrollViewer.VerticalScrollBarVisibility="Disabled">
                    <ListView.View>
                        <GridView>
                            <!-- Колонка № -->
                        <GridViewColumn Header="№" Width="50" HeaderContainerStyle="{StaticResource FirstColumnHeaderStyle}">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding TicketNumber}" 
                                               Foreground="White" 
                                               HorizontalAlignment="Center"
                                               TextAlignment="Center"
                                               VerticalAlignment="Center"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>                        

                        <!-- Колонка Тема -->
                        <GridViewColumn Header="Тема" Width="220" HeaderContainerStyle="{StaticResource ColumnHeaderStyle}">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Subject}" 
                                               Foreground="White" 
                                               TextWrapping="Wrap"
                                               HorizontalAlignment="Stretch"
                                               TextAlignment="Center"
                                               VerticalAlignment="Center"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <!-- Колонка Приоритет -->
                        <GridViewColumn Header="Приоритет" Width="100" HeaderContainerStyle="{StaticResource ColumnHeaderStyle}">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <Border Background="{Binding Priority, Converter={StaticResource PriorityToColorConverter}}"
                                            CornerRadius="3" 
                                            Padding="5,2"
                                            HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding Priority, Converter={StaticResource PriorityToRussianConverter}}" 
                                                   Foreground="White"
                                                   HorizontalAlignment="Center"
                                                   TextAlignment="Center"
                                                   VerticalAlignment="Center"/>
                                    </Border>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <!-- Колонка Очередь -->
                        <GridViewColumn Header="Тип запроса" Width="220" HeaderContainerStyle="{StaticResource ColumnHeaderStyle}">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Queue.Name}" 
                                               Foreground="White"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <!-- Колонка Автор -->
                        <GridViewColumn Header="Заявитель" Width="200" HeaderContainerStyle="{StaticResource ColumnHeaderStyle}">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Vertical" HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding Requestor.DisplayName}" 
                                                   Foreground="White"
                                                   HorizontalAlignment="Center"/>
                                        <TextBlock>
                                            <Hyperlink Command="{Binding DataContext.OpenEmailClientCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                       CommandParameter="{Binding Requestor.Email}"
                                                       Foreground="LightBlue"
                                                       TextDecorations="Underline">
                                                <Run Text="{Binding Requestor.Email}"/>
                                            </Hyperlink>
                                        </TextBlock>
                                    </StackPanel>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <!-- Колонка Статус -->
                        <GridViewColumn Header="Статус" Width="101" HeaderContainerStyle="{StaticResource ColumnHeaderStyle}">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <Border Background="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                            CornerRadius="3" 
                                            Padding="5,2"
                                            HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding Status, Converter={StaticResource StatusToRussianConverter}}" 
                                                   Foreground="White" 
                                                   FontSize="12"
                                                   HorizontalAlignment="Center"/>
                                    </Border>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>
                        </GridView>
                    </ListView.View>
                </ListView>

                <!-- Кнопка идет сразу после списка -->
                <Button Content="Обновить список"
                        Command="{Binding LoadTicketsCommand}"
                        HorizontalAlignment="Right"
                        Margin="0,20,10,0"
                        Style="{StaticResource MaterialDesignRaisedButton}"
                        Background="{DynamicResource PrimaryHueMidBrush}"
                        Foreground="White"/>
            </StackPanel>
        </ScrollViewer>
    </Border>
</UserControl>