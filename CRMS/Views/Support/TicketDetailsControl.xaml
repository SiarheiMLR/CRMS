<UserControl x:Class="CRMS.Views.Support.TicketDetailsControl" 
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" 
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:metro="http://metro.mahapps.com/winfx/xaml/controls" 
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes" 
             xmlns:fa="http://schemas.fontawesome.io/icons/"
             xmlns:local="clr-namespace:CRMS.Views.Support" 
             xmlns:viewModels="clr-namespace:CRMS.ViewModels.Support" 
             xmlns:converters="clr-namespace:CRMS.Infrastructure.Converters" 
             xmlns:domain="clr-namespace:CRMS.Domain.Entities;assembly=CRMS.Domain" 
             d:DataContext="{d:DesignInstance Type=viewModels:SupportTicketsViewModel}" 
             mc:Ignorable="d" 
             Background="Transparent" 
             Height="Auto" Width="Auto">

    <UserControl.Resources>
        <converters:StatusToRussianConverter x:Key="StatusToRussianConverter"/>
        <converters:PriorityToRussianConverter x:Key="PriorityToRussianConverter"/>
        <converters:StatusToColorConverter x:Key="StatusToColorConverter"/>
        <converters:PriorityToColorConverter x:Key="PriorityToColorConverter"/>
        <converters:XamlToFlowDocumentConverter x:Key="XamlToFlowDocumentConverter"/>
        <converters:XamlToTextConverter x:Key="XamlToTextConverter"/>
        <converters:StatusToIconConverter x:Key="StatusToIconConverter"/>
        <converters:PriorityToIconConverter x:Key="PriorityToIconConverter"/>
        <converters:ByteArrayToImageConverter x:Key="ByteArrayToImageConverter"/>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <converters:StatusToBooleanConverter x:Key="StatusToBooleanConverter"/>

        <!-- Стиль для кнопок действий -->
        <Style x:Key="ActionButtonStyle" TargetType="Button" BasedOn="{StaticResource MaterialDesignRaisedButton}">
            <Setter Property="Background" Value="{DynamicResource PrimaryHueMidBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Margin" Value="0,0,8,0"/>
            <Setter Property="Padding" Value="16,8"/>
        </Style>

        <!-- Стиль для текста "нет выбранной заявки" -->
        <Style x:Key="NoSelectionTextStyle" TargetType="TextBlock">
            <Setter Property="Visibility" Value="Collapsed"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding SelectedTicket}" Value="{x:Null}">
                    <Setter Property="Visibility" Value="Visible"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- Стиль для контейнера с деталями заявки -->
        <Style x:Key="DetailsViewStyle" TargetType="ScrollViewer">
            <Setter Property="Visibility" Value="Visible"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding SelectedTicket}" Value="{x:Null}">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Border CornerRadius="8" 
        BorderThickness="1" 
        BorderBrush="{DynamicResource MaterialDesignDivider}" 
        Background="Transparent" 
        Padding="10">

        <Grid>
            <Grid.RowDefinitions>
                <!-- Заголовок всегда сверху -->
                <RowDefinition Height="Auto"/>
                <!-- Контент -->
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Заголовок (фиксированный) -->
            <TextBlock Grid.Row="0"
                   Text="Информация о заявке:"
                   FontSize="16"
                   HorizontalAlignment="Center"
                   Margin="0,0,0,5"
                   Foreground="White"
                   FontWeight="Bold"/>
            <!-- Контейнер для состояния "нет выбранной заявки" -->
            <Grid Grid.Row="1">
                <TextBlock Text="Выберите заявку для просмотра подробной информации"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Foreground="White"
                       FontSize="16"
                       FontStyle="Italic"
                       Style="{StaticResource NoSelectionTextStyle}" />

                <!-- Контейнер для деталей заявки -->
                <ScrollViewer Style="{StaticResource DetailsViewStyle}">
                    <StackPanel Margin="10">
                        <!-- Номер заявки и плашки статуса/приоритета -->
                        <Grid Margin="0,0,0,20">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Номер заявки -->
                            <TextBlock Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Grid.RowSpan="2" Text="{Binding SelectedTicket.TicketNumber}" 
                                   FontSize="25" 
                                   FontWeight="Bold" 
                                   Foreground="White"
                                   VerticalAlignment="Top" HorizontalAlignment="Center"/>

                        <!-- Плашки статуса и приоритета (в правом верхнем углу) -->
                            <StackPanel Grid.Row="0" Grid.ColumnSpan="2"
                                    Orientation="Horizontal" 
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Top"
                                    Margin="5,0,50,0">
                                <!-- Плашка статуса -->
                                <Border Background="{Binding SelectedTicket.Status, Converter={StaticResource StatusToColorConverter}}" 
                                        CornerRadius="3" 
                                        Padding="8,4"
                                        Margin="0,0,0,2">
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                        <fa:ImageAwesome Icon="{Binding SelectedTicket.Status, Converter={StaticResource StatusToIconConverter}}"
                                                 Foreground="White"
                                                 Width="14"
                                                 Height="14"
                                                 Margin="0,0,4,0"/>
                                        <TextBlock Text="{Binding SelectedTicket.Status, Converter={StaticResource StatusToRussianConverter}}"
                                           Foreground="White"
                                           FontSize="8"
                                           FontWeight="Bold"
                                                   VerticalAlignment="Top" HorizontalAlignment="Left"/>
                                    </StackPanel>
                                </Border>

                                <!-- Плашка приоритета -->
                                <Border Background="{Binding SelectedTicket.Priority, Converter={StaticResource PriorityToColorConverter}}" 
                                        CornerRadius="3" 
                                        Padding="8,4"
                                        Margin="10,0,0,2">
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                        <fa:ImageAwesome Icon="{Binding SelectedTicket.Priority, Converter={StaticResource PriorityToIconConverter}}"
                                                 Foreground="White"
                                                 Width="14"
                                                 Height="14"
                                                 Margin="0,0,4,0"/>
                                        <TextBlock Text="{Binding SelectedTicket.Priority, Converter={StaticResource PriorityToRussianConverter}}"
                                           Foreground="White"
                                           FontSize="8"
                                           FontWeight="Bold"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Grid>

                    <!-- Карточка заявки -->
                        <Border Background="#333333" CornerRadius="5" Padding="15" Margin="0,0,0,20">
                            <StackPanel>
                                <TextBlock Text="Общая информация:" FontSize="14" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center" Margin="0,0,0,10"/>

                                <!-- Блок заявителя и контактов с аватаркой -->
                                <Border BorderBrush="LightGray" 
                                        BorderThickness="1" 
                                        CornerRadius="5" 
                                        Background="#20FFFFFF" 
                                        Margin="0,0,0,10"
                                        Padding="10">
                                    <Grid Margin="0,0,0,0">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Заявитель: " Foreground="LightGray" Margin="0,0,10,5"/>
                                        <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Vertical" Margin="0,0,0,5">
                                            <TextBlock Text="{Binding SelectedTicket.Requestor.DisplayName}" Foreground="White" Margin="0,0,0,5"/>
                                            <TextBlock Text="{Binding SelectedTicket.Requestor.JobTitle, FallbackValue='Не указана'}" Foreground="White" Margin="0,0,0,5"/>
                                            <TextBlock Text="{Binding SelectedTicket.Requestor.Department, FallbackValue='Не указан'}" Foreground="White" Margin="0,0,0,5"/>
                                        </StackPanel>

                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Контакты: " Foreground="LightGray" Margin="0,0,10,5"/>
                                        <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Vertical" Margin="0,0,0,5">
                                            <TextBlock Margin="0,0,10,5"> 
                                                <Hyperlink Command="{Binding OpenEmailClientCommand}" 
                                                           CommandParameter="{Binding SelectedTicket.Requestor.Email}" 
                                                           Foreground="LightBlue" 
                                                           TextDecorations="Underline"> 
                                                    <Run Text="{Binding SelectedTicket.Requestor.Email}"/> 
                                                </Hyperlink>
                                            </TextBlock>
                                            <TextBlock Text="{Binding SelectedTicket.Requestor.WorkPhone, FallbackValue='Не указан'}" Foreground="White" Margin="0,0,0,5"/>
                                            <TextBlock Text="{Binding SelectedTicket.Requestor.MobilePhone, FallbackValue='Не указан'}" Foreground="White" Margin="0,0,0,5"/>
                                        </StackPanel>

                                        <!-- Аватарка пользователя (занимает две строки) -->
                                        <Border Grid.Row="0" Grid.Column="2" Grid.RowSpan="2"
                                                BorderBrush="LightGray" 
                                                BorderThickness="1"
                                                CornerRadius="5"
                                                Margin="10,0,0,0"
                                                VerticalAlignment="Top"
                                                HorizontalAlignment="Left">
                                            <Image Source="{Binding SelectedTicket.Requestor.Avatar, Converter={StaticResource ByteArrayToImageConverter}}"
                                                   Width="100"
                                                   Height="100"
                                                   Stretch="UniformToFill"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center">
                                                <!-- Fallback изображение, если аватар отсутствует -->
                                                <Image.Style>
                                                    <Style TargetType="Image">
                                                        <Setter Property="Source" Value="{Binding SelectedTicket.Requestor.Avatar, Converter={StaticResource ByteArrayToImageConverter}}"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding SelectedTicket.Requestor.Avatar, Converter={StaticResource ByteArrayToImageConverter}}" Value="{x:Null}">
                                                                <Setter Property="Source" Value="/Resources/Images/no-avatar.jpg"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Image.Style>
                                            </Image>
                                        </Border>
                                    </Grid>
                                </Border>

                                <!-- Блок типа запроса и исполнителя -->
                                <Border BorderBrush="LightGray" 
                                        BorderThickness="1" 
                                        CornerRadius="5" 
                                        Background="#20FFFFFF" 
                                        Margin="0,0,0,10"
                                        Padding="10">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Тип запроса: " Foreground="LightGray" Margin="0,0,10,5"/>
                                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedTicket.Queue.Name}" Foreground="White" Margin="0,0,0,5"/>

                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Исполнитель: " Foreground="LightGray" Margin="0,0,10,5"/>
                                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedTicket.Supporter.DisplayName, FallbackValue='Не назначен'}" Foreground="White" Margin="0,0,0,5"/>
                                    </Grid>
                                </Border>

                                <!-- Блок с датами -->
                                <Border BorderBrush="LightGray" 
                                        BorderThickness="1" 
                                        CornerRadius="5" 
                                        Background="#20FFFFFF" 
                                        Margin="0,0,0,0"
                                        Padding="10">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Создана: " Foreground="LightGray" Margin="0,0,10,5"/>
                                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedTicket.Created, StringFormat='dd.MM.yyyy HH:mm'}" Foreground="White" Margin="0,0,0,5"/>
                                        <!-- Пустые колонки для первой строки -->
                                        <TextBlock Grid.Row="0" Grid.Column="2" Text="" Foreground="White" Margin="0,0,0,5"/>
                                        <TextBlock Grid.Row="0" Grid.Column="3" Text="" Foreground="White" Margin="0,0,0,5"/>

                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Взята на выполнение: " Foreground="LightGray" Margin="0,0,0,5"/>
                                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedTicket.StartedAt, StringFormat='dd.MM.yyyy HH:mm', TargetNullValue='Нет данных'}" Foreground="White" Margin="0,0,0,5"/>
                                        <TextBlock Grid.Row="1" Grid.Column="2" Text="{Binding StartedAtHeader}" Foreground="LightGray" Margin="0,0,0,5"/>
                                        <TextBlock Grid.Row="1" Grid.Column="3" Text="{Binding StartedAtTimeValue}" Foreground="{Binding StartedAtTimeColor}" FontWeight="Bold" Margin="0,0,0,5"/>

                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Завершена: " Foreground="LightGray" Margin="0,0,0,5"/>
                                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedTicket.CompletedAt, StringFormat='dd.MM.yyyy HH:mm', TargetNullValue='Нет данных'}" Foreground="White" Margin="0,0,0,5"/>
                                        <TextBlock Grid.Row="2" Grid.Column="2" Text="{Binding CompletedAtHeader}" Foreground="LightGray" Margin="0,0,0,5"/>
                                        <TextBlock Grid.Row="2" Grid.Column="3" Text="{Binding CompletedAtTimeValue}" Foreground="{Binding CompletedAtTimeColor}" FontWeight="Bold" Margin="0,0,0,5"/>
                                    </Grid>
                                </Border>                                
                            </StackPanel>
                        </Border>

                        <!-- Тема -->
                    <TextBlock Text="{Binding SelectedTicket.Subject}" 
                               FontSize="25" 
                               FontWeight="Bold" 
                               Foreground="White" 
                               Margin="0,0,0,5" 
                               TextWrapping="Wrap"
                               HorizontalAlignment="Center"/>
                        <Border CornerRadius="8" BorderThickness="1" BorderBrush="{DynamicResource MaterialDesignDivider}" Background="#333333" Padding="15" Margin="0,0,0,20">
                        <FlowDocumentScrollViewer 
                                Document="{Binding SelectedTicket.Content, Converter={StaticResource XamlToFlowDocumentConverter}}"
                                Foreground="White"
                                MaxHeight="300"
		                        VerticalScrollBarVisibility="Auto"
                                HorizontalScrollBarVisibility="Auto"
                                Padding="0"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch">
                            <FlowDocumentScrollViewer.Resources>
                                <Style TargetType="{x:Type Image}">
                                    <Setter Property="Source" Value="{Binding Source, RelativeSource={RelativeSource Self}}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Source, RelativeSource={RelativeSource Self}}" Value="{x:Null}">
                                            <Setter Property="ToolTip" Value="Изображение не может быть загружено"/>
                                            <Setter Property="Source" Value="/Resources/Images/placeholder.png"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </FlowDocumentScrollViewer.Resources>
                        </FlowDocumentScrollViewer>
                    </Border>

                    <!-- Секция для вложений -->
                    <TextBlock Text="Прикрепленные файлы:" 
                               FontSize="14" 
                               FontWeight="Bold" 
                               Foreground="White"
                               VerticalAlignment="Center"
                               Margin="0,0,0,10"/>
                    <Border CornerRadius="8" BorderThickness="1" BorderBrush="{DynamicResource MaterialDesignDivider}" Background="#333333" Padding="5" Margin="0,0,0,20">
                        <StackPanel Orientation="Horizontal">
                            <ItemsControl ItemsSource="{Binding SelectedTicket.Attachments}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Content="{Binding FileName}" 
                                                Command="{Binding DataContext.DownloadAttachmentCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"
                                                Style="{StaticResource MaterialDesignFlatButton}"
                                                Foreground="LightBlue"
                                                Margin="0,0,5,0"
                                                VerticalAlignment="Center" 
                                                HorizontalAlignment="Left"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                                <ItemsControl.Style>
                                    <Style TargetType="ItemsControl">
                                        <Setter Property="Visibility" Value="Visible"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding SelectedTicket.Attachments.Count}" Value="0">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ItemsControl.Style>
                            </ItemsControl>

                            <TextBlock Text="Отсутствуют"
                                       FontSize="14"
                                       Foreground="LightBlue"
                                       FontStyle="Italic"
                                       VerticalAlignment="Center"
                                       Margin="10,0,0,0">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding SelectedTicket.Attachments.Count}" Value="0">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </StackPanel>
                    </Border>

                        <!-- Действия -->
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,20,0,0">
                            <Button Content="Взять заявку" 
                                    Style="{StaticResource MaterialDesignRaisedButton}"
                                    Background="{DynamicResource PrimaryHueMidBrush}"
                                    Foreground="White"
                                    Margin="0 0 8 0" 
                                    Command="{Binding TakeTicketCommand}"
                                    IsEnabled="{Binding TakeTicketCommand.IsRunning, Converter={StaticResource InverseBooleanConverter}, Mode=OneWay}"/>

                            <Grid>
                                <Button Content="Изменить статус" 
                                        Style="{StaticResource MaterialDesignRaisedButton}"
                                        Background="{DynamicResource PrimaryHueMidBrush}"
                                        Foreground="White"
                                        Margin="0 0 8 0" 
                                        Command="{Binding ToggleStatusMenuCommand}"
                                        IsEnabled="{Binding CanChangeStatus}"/>

                                <!-- Всплывающее меню изменения статуса -->
                                <Popup IsOpen="{Binding IsStatusMenuOpen}" 
                                       PlacementTarget="{Binding RelativeSource={RelativeSource AncestorType=Grid}}"
                                       Placement="Bottom"
                                       StaysOpen="False">
                                    <Border Background="#333333" 
                                            CornerRadius="5" 
                                            BorderBrush="LightGray" 
                                            BorderThickness="1"
                                            Padding="10">
                                        <StackPanel>
                                            <!-- Кнопка "Закрыть заявку" -->
                                            <Button Content="Закрыть заявку" 
                                                    Style="{StaticResource MaterialDesignRaisedButton}"
                                                    Background="{DynamicResource PrimaryHueMidBrush}"
                                                    Foreground="White"
                                                    Margin="0 0 0 5"
                                                    Command="{Binding CloseTicketCommand}"
                                                    IsEnabled="{Binding SelectedTicket.Status, Converter={StaticResource StatusToBooleanConverter}, ConverterParameter=InProgress}"/>

                                            <!-- Кнопка "Отказаться от заявки" -->
                                            <Button Content="Отказаться от заявки" 
                                                    Style="{StaticResource MaterialDesignRaisedButton}"
                                                    Background="{DynamicResource PrimaryHueMidBrush}"
                                                    Foreground="White"
                                                    Margin="0 0 0 5"
                                                    Command="{Binding UnassignTicketCommand}"
                                                    IsEnabled="{Binding SelectedTicket.Status, Converter={StaticResource StatusToBooleanConverter}, ConverterParameter=InProgress}"/>

                                            <!-- Кнопка "Открыть заявку" -->
                                            <Button Content="Открыть повторно" 
                                                    Style="{StaticResource MaterialDesignRaisedButton}"
                                                    Background="{DynamicResource PrimaryHueMidBrush}"
                                                    Foreground="White"
                                                    Command="{Binding ReopenTicketCommand}"
                                                    IsEnabled="{Binding SelectedTicket.Status, Converter={StaticResource StatusToBooleanConverter}, ConverterParameter=Closed}"/>
                                        </StackPanel>
                                    </Border>
                                </Popup>
                            </Grid>

                            <Button Content="Добавить комментарий" 
                                    Style="{StaticResource MaterialDesignRaisedButton}"
                                    Background="{DynamicResource PrimaryHueMidBrush}"
                                    Foreground="White"
                                    Margin="0 0 8 0"  
                                    Command="{Binding AddCommentCommand}"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>
    </Border>
</UserControl>